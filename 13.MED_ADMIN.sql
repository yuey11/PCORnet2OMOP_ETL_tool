/*This file used to transform PCORnet MED_ADMIN table into the OMOP drug_exposure table.*/
/*TRUNCATE TABLE OMOP.dbo.drug_exposure;*/
/*Please run the PRESCRIBING table ETL code first!!*/


INSERT INTO OMOP.dbo.drug_exposure(
	drug_exposure_id, person_id, drug_concept_id, drug_exposure_start_date, drug_exposure_start_datetime,
	drug_exposure_end_date, drug_exposure_end_datetime, verbatim_end_date, drug_type_concept_id, route_concept_id, 
	provider_id, visit_occurrence_id, drug_source_value, drug_source_concept_id, route_source_value, 
	dose_unit_source_value)
SELECT 
	ROW_NUMBER() OVER (order by (select 1))+ (SELECT COALESCE(MAX(drug_exposure_id),0) FROM OMOP.dbo.drug_exposure),

	b.person_id,

	0,

	cast(MEDADMIN_START_DATE as date),

	CASE
	WHEN MEDADMIN_START_DATE IS NULL THEN '1900-01-01 00:00:00.000'
	WHEN MEDADMIN_START_DATE IS NOT NULL AND MEDADMIN_START_TIME IS NULL THEN MEDADMIN_START_DATE	
	WHEN MEDADMIN_START_DATE IS NOT NULL AND MEDADMIN_START_TIME IS NOT NULL THEN CONVERT(datetime, CONVERT(char(8),cast(MEDADMIN_START_DATE as date),112)+ ' ' + CONVERT(char(8),cast(MEDADMIN_START_TIME as time),108)) END,

	cast(MEDADMIN_STOP_DATE as date),

	CASE
	WHEN MEDADMIN_STOP_DATE IS NULL THEN '1900-01-01 00:00:00.000'
	WHEN MEDADMIN_STOP_DATE IS NOT NULL AND MEDADMIN_STOP_TIME IS NULL THEN MEDADMIN_STOP_DATE	
	WHEN MEDADMIN_STOP_DATE IS NOT NULL AND MEDADMIN_STOP_TIME IS NOT NULL THEN CONVERT(datetime, CONVERT(char(8),cast(MEDADMIN_STOP_DATE as date),112)+ ' ' + CONVERT(char(8),cast(MEDADMIN_STOP_TIME as time),108)) END,

	cast(MEDADMIN_STOP_DATE as date),
	
	38000178,

	CASE
	WHEN MEDADMIN_ROUTE = 'OTIC' THEN 4023156
	WHEN MEDADMIN_ROUTE = 'INTRA_ARTICULAR' THEN 4006860
	WHEN MEDADMIN_ROUTE = 'GASTROSTOMY' THEN 4132254
	WHEN MEDADMIN_ROUTE = 'JEJUNOSTOMY' THEN 4133177
	WHEN MEDADMIN_ROUTE = 'NASOGASTRIC' THEN 4132711
	WHEN MEDADMIN_ROUTE = 'SUBLESIONAL' THEN 46270168
	WHEN MEDADMIN_ROUTE = 'VAGINAL' THEN 4057765
	WHEN MEDADMIN_ROUTE = 'ORAL' THEN 4132161
	WHEN MEDADMIN_ROUTE = 'SUBCUTANEOUS' THEN 4142048
	WHEN MEDADMIN_ROUTE = 'RECTAL' THEN 4290759
	WHEN MEDADMIN_ROUTE = 'DENTAL' THEN 4163765
	WHEN MEDADMIN_ROUTE = 'ENDOCERVICAL' THEN 4186831
	WHEN MEDADMIN_ROUTE = 'ENDOSINUSIAL' THEN 4157756
	WHEN MEDADMIN_ROUTE = 'ENDOTRACHEOPULMONARY' THEN 4186832
	WHEN MEDADMIN_ROUTE = 'EXTRA_AMNIOTIC' THEN 4186833
	WHEN MEDADMIN_ROUTE = 'GASTROENTERAL' THEN 4186834
	WHEN MEDADMIN_ROUTE = 'GINGIVAL' THEN 4156704
	WHEN MEDADMIN_ROUTE = 'INTRAAMNIOTIC' THEN 4163767
	WHEN MEDADMIN_ROUTE = 'INTRABURSAL' THEN 4163768
	WHEN MEDADMIN_ROUTE = 'INTRACARDIAC' THEN 4156705
	WHEN MEDADMIN_ROUTE = 'INTRACAVERNOUS' THEN 4157757
	WHEN MEDADMIN_ROUTE = 'INTRACORONARY' THEN 4186836
	WHEN MEDADMIN_ROUTE = 'INTRADERMAL' THEN 4156706
	WHEN MEDADMIN_ROUTE = 'INTRADISCAL' THEN 4163769
	WHEN MEDADMIN_ROUTE = 'INTRALESIONAL' THEN 4157758
	WHEN MEDADMIN_ROUTE = 'INTRALYMPHATIC' THEN 4157759
	WHEN MEDADMIN_ROUTE = 'INTRAOCULAR' THEN 4157760
	WHEN MEDADMIN_ROUTE = 'INTRAPLEURAL' THEN 4156707
	WHEN MEDADMIN_ROUTE = 'INTRASTERNAL' THEN 4186837
	WHEN MEDADMIN_ROUTE = 'INTRAVESICAL' THEN 4186838
	WHEN MEDADMIN_ROUTE = 'OROMUCOSAL' THEN 4186839
	WHEN MEDADMIN_ROUTE = 'PERIARTICULAR' THEN 4156708
	WHEN MEDADMIN_ROUTE = 'PERINEURAL' THEN 4157761
	WHEN MEDADMIN_ROUTE = 'SUBCONJUNCTIVAL' THEN 4163770
	WHEN MEDADMIN_ROUTE = 'INTRALUMINAL' THEN 4292410
	WHEN MEDADMIN_ROUTE = 'SUBLINGUAL' THEN 4292110
	WHEN MEDADMIN_ROUTE = 'INTRAPERITONEAL' THEN 4243022
	WHEN MEDADMIN_ROUTE = 'TRANSMUCOSAL' THEN 4232601
	WHEN MEDADMIN_ROUTE = 'INTRATRACHEAL' THEN 4229543
	WHEN MEDADMIN_ROUTE = 'INTRABILIARY' THEN 4223965
	WHEN MEDADMIN_ROUTE = 'EPIDURAL' THEN 4225555
	WHEN MEDADMIN_ROUTE = 'SUBORBITAL' THEN 4166865
	WHEN MEDADMIN_ROUTE = 'CAUDAL' THEN 4220455
	WHEN MEDADMIN_ROUTE = 'INTRAOSSEOUS' THEN 4213522
	WHEN MEDADMIN_ROUTE = 'INTRATHORACIC' THEN 4167393
	WHEN MEDADMIN_ROUTE = 'ENTERAL' THEN 4167540
	WHEN MEDADMIN_ROUTE = 'INTRADUCTAL' THEN 4170083
	WHEN MEDADMIN_ROUTE = 'INTRATYMPANIC' THEN 4168656
	WHEN MEDADMIN_ROUTE = 'INTRAVENOUS_CENTRAL' THEN 4170113
	WHEN MEDADMIN_ROUTE = 'INTRAMYOMETRIAL' THEN 4168038
	WHEN MEDADMIN_ROUTE = 'GASTRO_INTESTINAL_STOMA' THEN 4168665
	WHEN MEDADMIN_ROUTE = 'COLOSTOMY' THEN 4168047
	WHEN MEDADMIN_ROUTE = 'PERIURETHRAL' THEN 4303646
	WHEN MEDADMIN_ROUTE = 'INTRACORONAL' THEN 4303667
	WHEN MEDADMIN_ROUTE = 'RETROBULBAR' THEN 4303673
	WHEN MEDADMIN_ROUTE = 'INTRACARTILAGINOUS' THEN 4303676
	WHEN MEDADMIN_ROUTE = 'INTRAVITREAL' THEN 4302785
	WHEN MEDADMIN_ROUTE = 'INTRASPINAL' THEN 4302788
	WHEN MEDADMIN_ROUTE = 'OROGASTRIC' THEN 4303795
	WHEN MEDADMIN_ROUTE = 'TRANSURETHRAL' THEN 4305382
	WHEN MEDADMIN_ROUTE = 'INTRATENDINOUS' THEN 4303939
	WHEN MEDADMIN_ROUTE = 'INTRACORNEAL' THEN 4305690
	WHEN MEDADMIN_ROUTE = 'OROPHARYNGEAL' THEN 4303277
	WHEN MEDADMIN_ROUTE = 'PERIBULBAR' THEN 4304274
	WHEN MEDADMIN_ROUTE = 'NASOJEJUNAL' THEN 4305834
	WHEN MEDADMIN_ROUTE = 'FISTULA' THEN 4304277
	WHEN MEDADMIN_ROUTE = 'SURGICAL_DRAIN' THEN 4304412
	WHEN MEDADMIN_ROUTE = 'INTRACAMERAL' THEN 4303409
	WHEN MEDADMIN_ROUTE = 'PARACERVICAL' THEN 4303515
	WHEN MEDADMIN_ROUTE = 'INTRASYNOVIAL' THEN 4302352
	WHEN MEDADMIN_ROUTE = 'INTRADUODENAL' THEN 4302354
	WHEN MEDADMIN_ROUTE = 'INTRACISTERNAL' THEN 4305993
	WHEN MEDADMIN_ROUTE = 'INTRATESTICULAR' THEN 4171067
	WHEN MEDADMIN_ROUTE = 'INTRACRANIAL' THEN 4171079
	WHEN MEDADMIN_ROUTE = 'TUMOR_CAVITY' THEN 4169472
	WHEN MEDADMIN_ROUTE = 'PARAVERTEBRAL' THEN 4170267
	WHEN MEDADMIN_ROUTE = 'INTRASINAL' THEN 4169440
	WHEN MEDADMIN_ROUTE = 'TRANSCERVICAL' THEN 4304730
	WHEN MEDADMIN_ROUTE = 'SUBTENDINOUS' THEN 4302493
	WHEN MEDADMIN_ROUTE = 'INTRAABDOMINAL' THEN 4304882
	WHEN MEDADMIN_ROUTE = 'SUBGINGIVAL' THEN 4306649
	WHEN MEDADMIN_ROUTE = 'INTRAOVARIAN' THEN 4306657
	WHEN MEDADMIN_ROUTE = 'URETERAL' THEN 4304571
	WHEN MEDADMIN_ROUTE = 'PERITENDINOUS' THEN 4305564
	WHEN MEDADMIN_ROUTE = 'INTRABRONCHIAL' THEN 4303263
	WHEN MEDADMIN_ROUTE = 'INTRAPROSTATIC' THEN 4171725
	WHEN MEDADMIN_ROUTE = 'SUBMUCOSAL' THEN 45956878
	WHEN MEDADMIN_ROUTE = 'SURGICAL_CAVITY' THEN 4170771
	WHEN MEDADMIN_ROUTE = 'ILEOSTOMY' THEN 4305679
	WHEN MEDADMIN_ROUTE = 'INTRAVENOUS_PERIPHERAL' THEN 4171884
	WHEN MEDADMIN_ROUTE = 'PERIOSTEAL' THEN 4171893
	WHEN MEDADMIN_ROUTE = 'ESOPHAGOSTOMY' THEN 4172191
	WHEN MEDADMIN_ROUTE = 'UROSTOMY' THEN 4170435
	WHEN MEDADMIN_ROUTE = 'LARYNGEAL' THEN 4170440
	WHEN MEDADMIN_ROUTE = 'INTRAPULMONARY' THEN 4169270
	WHEN MEDADMIN_ROUTE = 'MUCOUS_FISTULA' THEN 4171243
	WHEN MEDADMIN_ROUTE = 'NASODUODENAL' THEN 4172316
	WHEN MEDADMIN_ROUTE = 'BODY_CAVITY' THEN 4222254
	WHEN MEDADMIN_ROUTE = 'INTRAVENTRICULAR_CARDIAC' THEN 4222259
	WHEN MEDADMIN_ROUTE = 'INTRACEREBROVENTRICULAR' THEN 4224886
	WHEN MEDADMIN_ROUTE = 'PERCUTANEOUS' THEN 35627167
	WHEN MEDADMIN_ROUTE = 'INTERSTITIAL' THEN 4327128
	WHEN MEDADMIN_ROUTE = 'ARTERIOVENOUS_GRAFT' THEN 762840
	WHEN MEDADMIN_ROUTE = 'INTRAESOPHAGEAL' THEN 40492284
	WHEN MEDADMIN_ROUTE = 'INTRAGINGIVAL' THEN 40492286
	WHEN MEDADMIN_ROUTE = 'INTRAVASCULAR' THEN 40492287
	WHEN MEDADMIN_ROUTE = 'INTRADURAL' THEN 40492288
	WHEN MEDADMIN_ROUTE = 'INTRAMENINGEAL' THEN 40492300
	WHEN MEDADMIN_ROUTE = 'INTRAGASTRIC' THEN 40492301
	WHEN MEDADMIN_ROUTE = 'INTRACORPUS_CAVERNOSUM' THEN 40492302
	WHEN MEDADMIN_ROUTE = 'INTRAPERICARDIAL' THEN 40492305
	WHEN MEDADMIN_ROUTE = 'INTRALINGUAL' THEN 40493227
	WHEN MEDADMIN_ROUTE = 'INTRAHEPATIC' THEN 40493258
	WHEN MEDADMIN_ROUTE = 'CONJUNCTIVAL' THEN 40486444
	WHEN MEDADMIN_ROUTE = 'INTRAEPICARDIAL' THEN 40487473
	WHEN MEDADMIN_ROUTE = 'TRANSENDOCARDIAL' THEN 40487850
	WHEN MEDADMIN_ROUTE = 'TRANSPLACENTAL' THEN 40487858
	WHEN MEDADMIN_ROUTE = 'INTRACEREBRAL' THEN 40488317
	WHEN MEDADMIN_ROUTE = 'INTRAILEAL' THEN 40490837
	WHEN MEDADMIN_ROUTE = 'PERIODONTAL' THEN 40490866
	WHEN MEDADMIN_ROUTE = 'PERIDURAL' THEN 40490896
	WHEN MEDADMIN_ROUTE = 'LOWER_RESPIRATORY_TRACT' THEN 40490898
	WHEN MEDADMIN_ROUTE = 'INTRAMAMMARY' THEN 40491321
	WHEN MEDADMIN_ROUTE = 'INTRATUMOR' THEN 40491322
	WHEN MEDADMIN_ROUTE = 'TRANSTYMPANIC' THEN 40491830
	WHEN MEDADMIN_ROUTE = 'TRANSTRACHEAL' THEN 40491832
	WHEN MEDADMIN_ROUTE = 'RESPIRATORY_TRACT' THEN 40486069
	WHEN MEDADMIN_ROUTE = 'DIGESTIVE_TRACT' THEN 40487501
	WHEN MEDADMIN_ROUTE = 'INTRAEPIDERMAL' THEN 40487983
	WHEN MEDADMIN_ROUTE = 'INTRAJEJUNAL' THEN 40489989
	WHEN MEDADMIN_ROUTE = 'INTRACOLONIC' THEN 40489990
	WHEN MEDADMIN_ROUTE = 'CUTANEOUS' THEN 40490507
	WHEN MEDADMIN_ROUTE = 'TRANSDERMAL' THEN 4262099
	WHEN MEDADMIN_ROUTE = 'NASAL' THEN 4262914
	WHEN MEDADMIN_ROUTE = 'INTRAVENOUS' THEN 4171047
	WHEN MEDADMIN_ROUTE = 'BUCCAL' THEN 4181897
	WHEN MEDADMIN_ROUTE = 'OPHTHALMIC' THEN 4184451
	WHEN MEDADMIN_ROUTE = 'INTRA_ARTERIAL' THEN 4240824
	WHEN MEDADMIN_ROUTE = 'INTRAMEDULLARY' THEN 4246511
	WHEN MEDADMIN_ROUTE = 'TOPICAL' THEN 4263689
	WHEN MEDADMIN_ROUTE = 'INTRAUTERINE' THEN 4269621
	WHEN MEDADMIN_ROUTE = 'ARTERIOVENOUS_FISTULA' THEN 44783786
	WHEN MEDADMIN_ROUTE = 'INTRANEURAL' THEN 46272911
	WHEN MEDADMIN_ROUTE = 'INTRAMURAL' THEN 46272926
	WHEN MEDADMIN_ROUTE = 'EXTRACORPOREAL' THEN 37018288
	WHEN MEDADMIN_ROUTE = 'INTRATHECAL' THEN 4217202
	WHEN MEDADMIN_ROUTE = 'INTRAMUSCULAR' THEN 4302612
	WHEN MEDADMIN_ROUTE = 'URETHRAL' THEN 4233974
	WHEN MEDADMIN_ROUTE = 'NI' THEN 44814650
	WHEN MEDADMIN_ROUTE = 'UN' THEN 44814653
	WHEN MEDADMIN_ROUTE = 'OT' THEN 44814649
	WHEN MEDADMIN_ROUTE = '' THEN 44814653
	WHEN MEDADMIN_ROUTE IS NULL THEN 44814653 END,

	c.provider_id,
	
	d.visit_occurrence_id,

	MEDADMIN_CODE,

	0,

	MEDADMIN_ROUTE,

	MEDADMIN_DOSE_ADMIN_UNIT
	
FROM PCORnet.dbo.MED_ADMIN a  
LEFT JOIN OMOP.dbo.person b
ON a.PATID = b.person_source_value
LEFT JOIN OMOP.dbo.provider c
ON a.MEDADMIN_PROVIDERID = c.provider_source_value
LEFT JOIN OMOP.dbo.ENCOUNTERID_visit_occurrence_id_mapping d
ON a.ENCOUNTERID = d.ENCOUNTERID;


/*Fill the drug_source_concept_id value.*/
UPDATE OMOP.dbo.drug_exposure 
SET drug_source_concept_id = b.concept_id
FROM OMOP.dbo.drug_exposure a, OMOP.dbo.concept b
WHERE a.drug_source_value = b.concept_code and domain_id = 'Drug' and vocabulary_id in ('NDC', 'RxNorm') 
and a.drug_source_concept_id = 0;


/*Fill the drug_concept_id value.*/
UPDATE OMOP.dbo.drug_exposure
SET drug_concept_id = b.concept_id_2
FROM OMOP.dbo.concept_relationship b
WHERE drug_source_concept_id = b.concept_id_1 and relationship_id = 'Maps to'
and drug_concept_id = 0;






