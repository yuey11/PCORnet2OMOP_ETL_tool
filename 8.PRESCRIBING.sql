/*This file used to transform PCORnet PRESCRIBING table into the OMOP drug_exposure table.*/
/*TRUNCATE TABLE OMOP.dbo.drug_exposure;*/
/*Please run the PROVIDER table ETL code first!!*/
/*Please run the ENCOUNTER table ETL code first!!*/


INSERT INTO OMOP.dbo.drug_exposure(
	drug_exposure_id, person_id, drug_concept_id, drug_exposure_start_date, drug_exposure_start_datetime,
	drug_exposure_end_date, drug_exposure_end_datetime, drug_type_concept_id, refills, quantity, 
	days_supply, sig, route_concept_id, provider_id, visit_occurrence_id, 
	drug_source_value, drug_source_concept_id, route_source_value, dose_unit_source_value)
SELECT 
	ROW_NUMBER() OVER (order by (select 1))+ (SELECT COALESCE(MAX(drug_exposure_id),0) FROM OMOP.dbo.drug_exposure),

	b.person_id,

	0,

	cast(RX_START_DATE as date),

	CASE
	WHEN RX_START_DATE IS NOT NULL THEN RX_START_DATE
	WHEN RX_START_DATE IS NULL THEN '1900-01-01 00:00:00.000' END,

	cast(RX_END_DATE as date),

	CASE
	WHEN RX_END_DATE IS NOT NULL THEN RX_END_DATE
	WHEN RX_END_DATE IS NULL THEN '1900-01-01 00:00:00.000' END,

	581373,

	RX_REFILLS,

	RX_QUANTITY,

	RX_DAYS_SUPPLY,

	CASE
	WHEN RX_FREQUENCY = '01' THEN 'Every day'
	WHEN RX_FREQUENCY = '02' THEN 'Two times a day (BID)'
	WHEN RX_FREQUENCY = '03' THEN 'Three times a day (TID)'
	WHEN RX_FREQUENCY = '04' THEN 'Four times a day (QID)'
	WHEN RX_FREQUENCY = '05' THEN 'Every morning'
	WHEN RX_FREQUENCY = '06' THEN 'Every afternoon'
	WHEN RX_FREQUENCY = '07' THEN 'Before meals'
	WHEN RX_FREQUENCY = '08' THEN 'After meals'
	WHEN RX_FREQUENCY = '10' THEN 'Every evening'
	WHEN RX_FREQUENCY = '11' THEN 'Once'
	WHEN RX_FREQUENCY = 'NI' THEN 'No information'
	WHEN RX_FREQUENCY = 'UN' THEN 'Unknown'
	WHEN RX_FREQUENCY = 'OT' THEN 'Other' END,

	CASE
	WHEN RX_ROUTE = 'OTIC' THEN 4023156
	WHEN RX_ROUTE = 'INTRA_ARTICULAR' THEN 4006860
	WHEN RX_ROUTE = 'GASTROSTOMY' THEN 4132254
	WHEN RX_ROUTE = 'JEJUNOSTOMY' THEN 4133177
	WHEN RX_ROUTE = 'NASOGASTRIC' THEN 4132711
	WHEN RX_ROUTE = 'SUBLESIONAL' THEN 46270168
	WHEN RX_ROUTE = 'VAGINAL' THEN 4057765
	WHEN RX_ROUTE = 'ORAL' THEN 4132161
	WHEN RX_ROUTE = 'SUBCUTANEOUS' THEN 4142048
	WHEN RX_ROUTE = 'RECTAL' THEN 4290759
	WHEN RX_ROUTE = 'DENTAL' THEN 4163765
	WHEN RX_ROUTE = 'ENDOCERVICAL' THEN 4186831
	WHEN RX_ROUTE = 'ENDOSINUSIAL' THEN 4157756
	WHEN RX_ROUTE = 'ENDOTRACHEOPULMONARY' THEN 4186832
	WHEN RX_ROUTE = 'EXTRA_AMNIOTIC' THEN 4186833
	WHEN RX_ROUTE = 'GASTROENTERAL' THEN 4186834
	WHEN RX_ROUTE = 'GINGIVAL' THEN 4156704
	WHEN RX_ROUTE = 'INTRAAMNIOTIC' THEN 4163767
	WHEN RX_ROUTE = 'INTRABURSAL' THEN 4163768
	WHEN RX_ROUTE = 'INTRACARDIAC' THEN 4156705
	WHEN RX_ROUTE = 'INTRACAVERNOUS' THEN 4157757
	WHEN RX_ROUTE = 'INTRACORONARY' THEN 4186836
	WHEN RX_ROUTE = 'INTRADERMAL' THEN 4156706
	WHEN RX_ROUTE = 'INTRADISCAL' THEN 4163769
	WHEN RX_ROUTE = 'INTRALESIONAL' THEN 4157758
	WHEN RX_ROUTE = 'INTRALYMPHATIC' THEN 4157759
	WHEN RX_ROUTE = 'INTRAOCULAR' THEN 4157760
	WHEN RX_ROUTE = 'INTRAPLEURAL' THEN 4156707
	WHEN RX_ROUTE = 'INTRASTERNAL' THEN 4186837
	WHEN RX_ROUTE = 'INTRAVESICAL' THEN 4186838
	WHEN RX_ROUTE = 'OROMUCOSAL' THEN 4186839
	WHEN RX_ROUTE = 'PERIARTICULAR' THEN 4156708
	WHEN RX_ROUTE = 'PERINEURAL' THEN 4157761
	WHEN RX_ROUTE = 'SUBCONJUNCTIVAL' THEN 4163770
	WHEN RX_ROUTE = 'INTRALUMINAL' THEN 4292410
	WHEN RX_ROUTE = 'SUBLINGUAL' THEN 4292110
	WHEN RX_ROUTE = 'INTRAPERITONEAL' THEN 4243022
	WHEN RX_ROUTE = 'TRANSMUCOSAL' THEN 4232601
	WHEN RX_ROUTE = 'INTRATRACHEAL' THEN 4229543
	WHEN RX_ROUTE = 'INTRABILIARY' THEN 4223965
	WHEN RX_ROUTE = 'EPIDURAL' THEN 4225555
	WHEN RX_ROUTE = 'SUBORBITAL' THEN 4166865
	WHEN RX_ROUTE = 'CAUDAL' THEN 4220455
	WHEN RX_ROUTE = 'INTRAOSSEOUS' THEN 4213522
	WHEN RX_ROUTE = 'INTRATHORACIC' THEN 4167393
	WHEN RX_ROUTE = 'ENTERAL' THEN 4167540
	WHEN RX_ROUTE = 'INTRADUCTAL' THEN 4170083
	WHEN RX_ROUTE = 'INTRATYMPANIC' THEN 4168656
	WHEN RX_ROUTE = 'INTRAVENOUS_CENTRAL' THEN 4170113
	WHEN RX_ROUTE = 'INTRAMYOMETRIAL' THEN 4168038
	WHEN RX_ROUTE = 'GASTRO_INTESTINAL_STOMA' THEN 4168665
	WHEN RX_ROUTE = 'COLOSTOMY' THEN 4168047
	WHEN RX_ROUTE = 'PERIURETHRAL' THEN 4303646
	WHEN RX_ROUTE = 'INTRACORONAL' THEN 4303667
	WHEN RX_ROUTE = 'RETROBULBAR' THEN 4303673
	WHEN RX_ROUTE = 'INTRACARTILAGINOUS' THEN 4303676
	WHEN RX_ROUTE = 'INTRAVITREAL' THEN 4302785
	WHEN RX_ROUTE = 'INTRASPINAL' THEN 4302788
	WHEN RX_ROUTE = 'OROGASTRIC' THEN 4303795
	WHEN RX_ROUTE = 'TRANSURETHRAL' THEN 4305382
	WHEN RX_ROUTE = 'INTRATENDINOUS' THEN 4303939
	WHEN RX_ROUTE = 'INTRACORNEAL' THEN 4305690
	WHEN RX_ROUTE = 'OROPHARYNGEAL' THEN 4303277
	WHEN RX_ROUTE = 'PERIBULBAR' THEN 4304274
	WHEN RX_ROUTE = 'NASOJEJUNAL' THEN 4305834
	WHEN RX_ROUTE = 'FISTULA' THEN 4304277
	WHEN RX_ROUTE = 'SURGICAL_DRAIN' THEN 4304412
	WHEN RX_ROUTE = 'INTRACAMERAL' THEN 4303409
	WHEN RX_ROUTE = 'PARACERVICAL' THEN 4303515
	WHEN RX_ROUTE = 'INTRASYNOVIAL' THEN 4302352
	WHEN RX_ROUTE = 'INTRADUODENAL' THEN 4302354
	WHEN RX_ROUTE = 'INTRACISTERNAL' THEN 4305993
	WHEN RX_ROUTE = 'INTRATESTICULAR' THEN 4171067
	WHEN RX_ROUTE = 'INTRACRANIAL' THEN 4171079
	WHEN RX_ROUTE = 'TUMOR_CAVITY' THEN 4169472
	WHEN RX_ROUTE = 'PARAVERTEBRAL' THEN 4170267
	WHEN RX_ROUTE = 'INTRASINAL' THEN 4169440
	WHEN RX_ROUTE = 'TRANSCERVICAL' THEN 4304730
	WHEN RX_ROUTE = 'SUBTENDINOUS' THEN 4302493
	WHEN RX_ROUTE = 'INTRAABDOMINAL' THEN 4304882
	WHEN RX_ROUTE = 'SUBGINGIVAL' THEN 4306649
	WHEN RX_ROUTE = 'INTRAOVARIAN' THEN 4306657
	WHEN RX_ROUTE = 'URETERAL' THEN 4304571
	WHEN RX_ROUTE = 'PERITENDINOUS' THEN 4305564
	WHEN RX_ROUTE = 'INTRABRONCHIAL' THEN 4303263
	WHEN RX_ROUTE = 'INTRAPROSTATIC' THEN 4171725
	WHEN RX_ROUTE = 'SUBMUCOSAL' THEN 45956878
	WHEN RX_ROUTE = 'SURGICAL_CAVITY' THEN 4170771
	WHEN RX_ROUTE = 'ILEOSTOMY' THEN 4305679
	WHEN RX_ROUTE = 'INTRAVENOUS_PERIPHERAL' THEN 4171884
	WHEN RX_ROUTE = 'PERIOSTEAL' THEN 4171893
	WHEN RX_ROUTE = 'ESOPHAGOSTOMY' THEN 4172191
	WHEN RX_ROUTE = 'UROSTOMY' THEN 4170435
	WHEN RX_ROUTE = 'LARYNGEAL' THEN 4170440
	WHEN RX_ROUTE = 'INTRAPULMONARY' THEN 4169270
	WHEN RX_ROUTE = 'MUCOUS_FISTULA' THEN 4171243
	WHEN RX_ROUTE = 'NASODUODENAL' THEN 4172316
	WHEN RX_ROUTE = 'BODY_CAVITY' THEN 4222254
	WHEN RX_ROUTE = 'INTRAVENTRICULAR_CARDIAC' THEN 4222259
	WHEN RX_ROUTE = 'INTRACEREBROVENTRICULAR' THEN 4224886
	WHEN RX_ROUTE = 'PERCUTANEOUS' THEN 35627167
	WHEN RX_ROUTE = 'INTERSTITIAL' THEN 4327128
	WHEN RX_ROUTE = 'ARTERIOVENOUS_GRAFT' THEN 762840
	WHEN RX_ROUTE = 'INTRAESOPHAGEAL' THEN 40492284
	WHEN RX_ROUTE = 'INTRAGINGIVAL' THEN 40492286
	WHEN RX_ROUTE = 'INTRAVASCULAR' THEN 40492287
	WHEN RX_ROUTE = 'INTRADURAL' THEN 40492288
	WHEN RX_ROUTE = 'INTRAMENINGEAL' THEN 40492300
	WHEN RX_ROUTE = 'INTRAGASTRIC' THEN 40492301
	WHEN RX_ROUTE = 'INTRACORPUS_CAVERNOSUM' THEN 40492302
	WHEN RX_ROUTE = 'INTRAPERICARDIAL' THEN 40492305
	WHEN RX_ROUTE = 'INTRALINGUAL' THEN 40493227
	WHEN RX_ROUTE = 'INTRAHEPATIC' THEN 40493258
	WHEN RX_ROUTE = 'CONJUNCTIVAL' THEN 40486444
	WHEN RX_ROUTE = 'INTRAEPICARDIAL' THEN 40487473
	WHEN RX_ROUTE = 'TRANSENDOCARDIAL' THEN 40487850
	WHEN RX_ROUTE = 'TRANSPLACENTAL' THEN 40487858
	WHEN RX_ROUTE = 'INTRACEREBRAL' THEN 40488317
	WHEN RX_ROUTE = 'INTRAILEAL' THEN 40490837
	WHEN RX_ROUTE = 'PERIODONTAL' THEN 40490866
	WHEN RX_ROUTE = 'PERIDURAL' THEN 40490896
	WHEN RX_ROUTE = 'LOWER_RESPIRATORY_TRACT' THEN 40490898
	WHEN RX_ROUTE = 'INTRAMAMMARY' THEN 40491321
	WHEN RX_ROUTE = 'INTRATUMOR' THEN 40491322
	WHEN RX_ROUTE = 'TRANSTYMPANIC' THEN 40491830
	WHEN RX_ROUTE = 'TRANSTRACHEAL' THEN 40491832
	WHEN RX_ROUTE = 'RESPIRATORY_TRACT' THEN 40486069
	WHEN RX_ROUTE = 'DIGESTIVE_TRACT' THEN 40487501
	WHEN RX_ROUTE = 'INTRAEPIDERMAL' THEN 40487983
	WHEN RX_ROUTE = 'INTRAJEJUNAL' THEN 40489989
	WHEN RX_ROUTE = 'INTRACOLONIC' THEN 40489990
	WHEN RX_ROUTE = 'CUTANEOUS' THEN 40490507
	WHEN RX_ROUTE = 'TRANSDERMAL' THEN 4262099
	WHEN RX_ROUTE = 'NASAL' THEN 4262914
	WHEN RX_ROUTE = 'INTRAVENOUS' THEN 4171047
	WHEN RX_ROUTE = 'BUCCAL' THEN 4181897
	WHEN RX_ROUTE = 'OPHTHALMIC' THEN 4184451
	WHEN RX_ROUTE = 'INTRA_ARTERIAL' THEN 4240824
	WHEN RX_ROUTE = 'INTRAMEDULLARY' THEN 4246511
	WHEN RX_ROUTE = 'TOPICAL' THEN 4263689
	WHEN RX_ROUTE = 'INTRAUTERINE' THEN 4269621
	WHEN RX_ROUTE = 'ARTERIOVENOUS_FISTULA' THEN 44783786
	WHEN RX_ROUTE = 'INTRANEURAL' THEN 46272911
	WHEN RX_ROUTE = 'INTRAMURAL' THEN 46272926
	WHEN RX_ROUTE = 'EXTRACORPOREAL' THEN 37018288
	WHEN RX_ROUTE = 'INTRATHECAL' THEN 4217202
	WHEN RX_ROUTE = 'INTRAMUSCULAR' THEN 4302612
	WHEN RX_ROUTE = 'URETHRAL' THEN 4233974
	WHEN RX_ROUTE = 'NI' THEN 44814650
	WHEN RX_ROUTE = 'UN' THEN 44814653
	WHEN RX_ROUTE = 'OT' THEN 44814649
	WHEN RX_ROUTE = '' THEN 44814653
	WHEN RX_ROUTE IS NULL THEN 44814653 END,

	c.provider_id,

	d.visit_occurrence_id,

	RXNORM_CUI,

	0,

	RX_ROUTE,

	RX_DOSE_ORDERED_UNIT

FROM PCORnet.dbo.PRESCRIBING a  
LEFT JOIN OMOP.dbo.person b
ON a.PATID = b.person_source_value
LEFT JOIN OMOP.dbo.provider c
ON a.RX_PROVIDERID = c.provider_source_value
LEFT JOIN OMOP.dbo.ENCOUNTERID_visit_occurrence_id_mapping d
ON a.ENCOUNTERID = d.ENCOUNTERID;


/*Fill the drug_source_concept_id value.*/
UPDATE OMOP.dbo.drug_exposure 
SET drug_source_concept_id = b.concept_id
FROM OMOP.dbo.drug_exposure a, OMOP.dbo.concept b
WHERE a.drug_source_value = b.concept_code and domain_id = 'Drug' and vocabulary_id = 'RxNorm';


/*Fill the drug_concept_id value.*/
UPDATE OMOP.dbo.drug_exposure
SET drug_concept_id = drug_source_concept_id
FROM OMOP.dbo.drug_exposure;


